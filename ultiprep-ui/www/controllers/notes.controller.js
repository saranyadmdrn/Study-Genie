var app=angular.module("ultiprep");app.controller("notesController",["$scope","$state","authentication","data",function(e,t,o,n){function r(){e.someNotes=[];for(var t=0;t<e.notes.length;t++)e.someNotes.push(e.notes[t])}e.tags=[],e.selectedTags=[],e.notes=[],e.note={title:"",content:"",dateCreated:"",tags:[],isPinned:{},isTrashed:{},timestamp:new Date,author:""},e.currentNote=null,e.titleMaxLength=100,e.tagMaxLength=20,e.someNotes=[],e.userGroups={},e.groups=[],e.users=[],e.froalaOptions={heightMin:300,heightMax:375,zIndex:9e3,multiLine:!0,placeholderText:"Take a note...",charCounterCount:!1,toolbarInline:!1,toolbarButtons:["bold","italic","underline","|","align","formatOL","formatUL","|","color","emoticons","insertLink","insertImage","insertFile","html"],toolbarButtonsMD:["bold","italic","underline","|","align","formatOL","formatUL","|","color","emoticons","insertLink","insertImage","insertFile","html"],toolbarButtonsSM:["bold","italic","underline","|","align","formatOL","formatUL","|","color","emoticons","insertLink","insertImage","insertFile","html"],toolbarButtonsXS:["bold","italic","underline","|","align","formatOL","formatUL","|","color","emoticons","insertLink","insertImage","insertFile","html"],tooltips:!0,spellcheck:!0,tabSpaces:4,theme:"gray",immediateAngularModelUpdate:!0},e.currentUser={},e.isLoggedIn=o.isLoggedIn(),n.getUser().success(function(t){e.currentUser=t,e.note.isPinned[e.currentUser._id]=!1,n.getRecommendedNotes(e.currentUser._id).success(function(t){e.notes=[];for(var o=0;o<t.result.length;o++){var n=JSON.parse(t.result[o]);n._id=n._id.$oid,console.log(n),e.notes.push(JSON.parse(t.result[o]))}r()}).error(function(e){alertToast("An error occurred while loading notes. "+e.message)})}).error(function(t){alertToast("An error occurred while loading user details. "+t.message),-1!==t.message.indexOf("not found")&&e.logout()}),n.getUserTags().success(function(t){e.tags=t.tags}).error(function(e){alertToast("An error occurred while loading tags. "+e.message)}),n.getUserGroups().success(function(t){e.userGroups=t,console.log(e.userGroups)}).error(function(e){alertToast("An error occurred while loading groups. "+e.message)}),n.getAllGroups().success(function(t){e.groups=t,console.log(e.groups)}).error(function(e){alertToast("An error occurred while loading groups. "+e.message)}),n.getAllUsers().success(function(t){e.users=t,console.log(e.users)}).error(function(e){alertToast("An error occurred while loading groups. "+e.message)}),e.onClick=function(e,t){n.postEvent(s("note_open",e)).success(function(){}).error(function(e){})},e.duplicateNote=function(t){if(null!==t&&"object"==typeof t){var o={};o.title=t.title,o.author=e.currentUser._id,o.content=t.content,o.dateCreated=i(),o.tags=t.tags.slice(),o.isPinned={},o.isPinned[e.currentUser._id]=t.isPinned[e.currentUser._id]||!1,o.isTrashed={},o.isTrashed[e.currentUser._id]=t.isTrashed[e.currentUser._id]||!1,o.timestamp=new Date,e.someNotes.unshift(o),n.addNote(o),setTimeout(function(){n.getNotes().success(function(t){e.notes=t.sort(reverseCompareTimestamps),r(),t.postEvent(s("note_copy",e.notes[0])).success(function(){}).error(function(e){})}).error(function(e){alertToast("An error occurred while loading notes. "+e.message)})},300)}},e.loadMore=function(){e.someNotes.length},e.pinNote=function(t){null!==t&&"object"==typeof t&&(t.isPinned[e.currentUser._id]=!0,n.updateNote(t),n.postEvent(s("note_pin",t)).success(function(){}).error(function(e){}))},e.pinNoteViaModal=function(t,o){$("#note-view-modal-"+o).on("hidden.bs.modal",function(){e.pinNote(t),e.$apply()}),$("#note-edit-modal-"+o).on("hidden.bs.modal",function(){e.pinNote(t),e.$apply()})},e.unpinNote=function(t){null!==t&&"object"==typeof t&&(t.isPinned[e.currentUser._id]=!1,n.updateNote(t),n.postEvent(s("note_unpin",t)).success(function(){}).error(function(e){}))},e.unpinNoteViaModal=function(t,o){$("#note-view-modal-"+o).on("hidden.bs.modal",function(){e.unpinNote(t),e.$apply()}),$("#note-edit-modal-"+o).on("hidden.bs.modal",function(){e.unpinNote(t),e.$apply()})},e.moveNoteToTrash=function(t){null!==t&&"object"==typeof t&&(t.isTrashed[e.currentUser._id]=!0,n.updateNote(t),n.postEvent(s("note_trash",t)).success(function(){}).error(function(e){}))},e.isAuthor=function(t){return t.author==e.currentUser._id},e.moveNoteToTrashViaModal=function(t,o){$("#note-view-modal-"+o).on("hidden.bs.modal",function(){e.moveNoteToTrash(t),e.$apply()}),$("#note-edit-modal-"+o).on("hidden.bs.modal",function(){e.moveNoteToTrash(t),e.$apply()})},e.removeNoteFromTrash=function(t){null!==t&&"object"==typeof t&&(t.isTrashed[e.currentUser._id]=!1,n.updateNote(t),n.postEvent(s("note_untrash",t)).success(function(){}).error(function(e){}))},e.removeNoteFromTrashViaModal=function(t,o){$("#note-view-modal-"+o).on("hidden.bs.modal",function(){e.removeNoteFromTrash(t),e.$apply()}),$("#note-edit-modal-"+o).on("hidden.bs.modal",function(){e.removeNoteFromTrash(t),e.$apply()})},e.deleteNotePermanently=function(t){if(null!==t&&"object"==typeof t){var o=e.someNotes.indexOf(t);e.someNotes.splice(o,1);var r=e.notes.indexOf(t);e.notes.splice(r,1),n.removeNote(t),n.postEvent(s("note_delete",t)).success(function(){}).error(function(e){}),e.apply()}},e.deleteNotePermanentlyViaModal=function(t,o){$("#note-view-modal-"+o).on("hidden.bs.modal",function(){e.permanentlyRemoveNote(t),e.$apply()}),$("#note-edit-modal-"+o).on("hidden.bs.modal",function(){e.permanentlyRemoveNote(t),e.$apply()})},e.createNote=function(){e.searchString="",t.go("notes.state-notes");var o={};o.title="",o.content="",o.dateCreated=i(),o.tags=[],o.isPinned={},o.isPinned[e.currentUser._id]=!0,o.isTrashed={},o.isTrashed[e.currentUser._id]=!1,o.timestamp=new Date,o.contributors=[],o.author=e.currentUser._id,e.notes.unshift(o),n.addNote(o),setTimeout(function(){n.getNotes().success(function(t){e.notes=t.sort(reverseCompareTimestamps),r(),console.log(e.notes[0]),e.currentNote=e.notes[0],setTimeout(function(){$("#note-edit-modal-0").modal("show")},30),n.postEvent(s("note_create",e.notes[0])).success(function(){}).error(function(e){})}).error(function(e){alertToast("Could not delete note. "+e.message)})},300)},e.checkNoteTag=function(e,t){return-1!=e.tags.indexOf(t)},e.checkGroupMember=function(e,t){return-1!=e.members.indexOf(t)},e.checkUserAccess=function(e,t){return-1!=e.contributors.indexOf(t)},e.isMember=function(t){return e.checkGroupMember(t,e.currentUser._id)},e.getGroupClass=function(t){return e.isMember(t)?"member":"non-member"},e.joinGroup=function(t){t.members.indexOf(e.currentUser._id)<0&&(t.members.push(e.currentUser._id),n.joinGroup(t))},e.leaveGroup=function(t){t.members.indexOf(e.currentUser._id)>-1&&(t.members.splice(t.members.indexOf(e.currentUser._id)),n.leaveGroup(t))},e.changeNoteTag=function(e,t){if(null!==e&&null!==t&&"object"==typeof e&&"string"==typeof t){var o=e.tags.indexOf(t);-1==o?e.tags.push(t):e.tags.splice(o,1),n.updateNote(e),n.postEvent(s("note_update",e)).success(function(){}).error(function(e){})}},e.changeUserAccess=function(e,t){if(null!==e&&null!==t&&"object"==typeof e&&"string"==typeof t){var o=e.contributors.indexOf(t);-1==o?e.contributors.push(t):e.contributors.splice(o,1),n.updateNote(e),n.postEvent(s("note_update",e)).success(function(){}).error(function(e){})}},e.changeNoteTagViaTagsPage=function(t,o,r){if(null!==t&&null!==o&&"object"==typeof t&&"string"==typeof o){var i=t.tags.indexOf(o);-1==i?t.tags.push(o):-1==e.selectedTags.indexOf(o)?t.tags.splice(i,1):($("#note-edit-modal-"+r).on("hidden.bs.modal",function(){t.tags.splice(i,1),e.$apply()}),$("#note-edit-modal-"+r).modal("hide")),n.updateNote(t),n.postEvent(s("note_update",t)).success(function(){}).error(function(e){})}},e.addTag=function(t){if($("#add-tag-form input").val(""),null!==t&&"string"==typeof t){for(var o=0;o<e.tags.length;o++)if(t.toLowerCase()==e.tags[o].toLowerCase())return void alertToast("Tag already exists.");e.tags.push(t),setRippleEffects(),n.addTag(t),n.postEvent(s("tag_add",t)).success(function(){}).error(function(e){})}},e.removeTag=function(t){if(null!==t&&"string"==typeof t){for(o=0;o<e.notes.length;o++)void 0!==e.notes[o].tags&&-1!=(r=e.notes[o].tags.indexOf(t))&&(e.notes[o].tags.splice(r,1),n.updateNote(e.notes[o]),n.postEvent(s("note_update",e.notes[o])).success(function(){}).error(function(e){}));for(var o=0;o<e.someNotes.length;o++)void 0!==e.notes[o].tags&&-1!=(r=e.someNotes[o].tags.indexOf(t))&&e.someNotes[o].tags.splice(r,1);var r=e.tags.indexOf(t);e.tags.splice(r,1),n.removeTag(t),n.postEvent(s("tag_remove",newTag)).success(function(){}).error(function(e){})}},e.setSelectedTags=function(t){e.selectedTags=t,n.postEvent(s("tag_open",t[0])).success(function(){}).error(function(e){})},e.setCurrentNote=function(t){null!==t&&"object"==typeof t&&(e.currentNote=t,n.postEvent(s("note_open",e.currentNote)).success(function(){}).error(function(e){}))},e.openEditModalViaViewModal=function(t,o){$("#note-view-modal-"+o).modal("hide"),$("#note-edit-modal-"+o).modal("show"),e.currentNote=t},e.setEditModalCloseToResetCurrentNote=function(){$(".note-edit-modal").off("hidden.bs.modal"),$(".note-edit-modal").on("hidden.bs.modal",function(){n.updateNote(e.currentNote),n.postEvent(s("note_update",e.currentNote)).success(function(){}).error(function(e){}),e.currentNote=null})},e.isSelf=function(t){return console.log(t),t==e.currentUser._id},e.shareNote=function(e,t){},e.logNotes=function(){console.log(e.notes)},e.logout=function(){o.logOut(),t.go("landing")};var s=function(e,t){var o={};return o.type=e,o.data=t,o.dateCreated=i(),o.timeStamp=new Date,o},i=function(){var e=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],t=new Date;return e[t.getMonth()]+" "+t.getDate()+", "+t.getFullYear()},a=0;e.$on("ngRepeatFinished",function(t){a++,console.log("ngRepeatFinished "+a),null!=e.currentNote&&a>=10&&(n.updateNoteContent(e.currentNote),a=0),textareaAutoResizer(),e.setEditModalCloseToResetCurrentNote(),setLayout(5)})}]);